<!DOCTYPE html>
<html>
  <head>
    <title>Part 1. Web Scraping</title>
    <meta charset="utf-8">
    <meta name="author" content="MeDaScIn 2018" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="duke_color_pallettes_slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Part 1. Web Scraping
## Sports Analytics with R
### MeDaScIn 2018

---






# About Me

.pull-left[
- I'm a Data Scientist focusing on performance analysis in tennis

- I work for Tennis Australia's Game Insight Group

- I run a tennis stats blog [on-the-t.com](on-the-t.com)

- I tweet about tennis and data science @StatsOnTheT
]

.pull-right[
&lt;img src="gig_logo_no_text.png" width=200 /&gt;
]


---


# Tutorial Resources

- Github: [github.com/skoval/MeDaScIn2018](https://github.com/skoval/MeDaScIn)

- Contact: [skovalchik@tennis.com.au](skovalchik@tennis.com.au)

---

# Tutorial Outline

Part 1. Web scraping

Part 2. Pythagorean Expectation

Part 3. Paired Comparisons

Part 4. Hierarchical Models &amp; Shrinkage

Part 5. GAM


---

# Ways of Getting Sports Data

As a sports statistician you will often need to gather data from the Web. Here are some common ways to get these data:

--

- &lt;b&gt;Import&lt;/b&gt;. Read a data file directly from a Website

--

- &lt;b&gt;Scrape&lt;/b&gt;. Pull data from the underlying source code in one of the following ways:

  1. Extraction from HTML for static data
  
  2. Importing the underlying data objects for dynamic pages (if possible)
  
  3. Extraction through automated browsing for data that is generated dynamically

---



# Import Data File

--

- Some sports sites, like [Baseball-Reference.com](http://www.baseball-reference.com), provide tools for creating exportable reports.

--

- More generic sites like Kaggle and GitHub also can be a resource for downloadable sports data

--

- In general, we want to avoid manual data collection and automate wherever possible because: *automation = efficiency*

--

- Sports data that is on the Web as an importable file can be imported with `read.table` or similar import function in R if we can determine it's URL

---


# Example: Import Data File

Here we extract the most recent Australian Open match results and betting odds using `read.csv`.


```r
url &lt;- "http://www.tennis-data.co.uk/2017/ausopen.csv"

read.csv(url)
```

---



# Practice: Import Data File

How do you think you would obtain the same data from the last US Open? 

--

1. Give it a try.

2. Read in the data.

3. Determine the number of matches included.

---

# Solution: Import Data File

To solve this one, we have to recognise patterns in the URL and see where we might request a different year and event.

![](pattern_url.png)


---

# Solution: Import Data File



```r
url &lt;- "http://www.tennis-data.co.uk/2018/usopen.csv"

usopen &lt;- read.csv(url)

nrow(usopen) # Number of matches
```

```
## [1] 127
```

---


# Web Scraping

&lt;b&gt;More often you will need to go "under the hood" and work directly with HTML/CSS to extract data from Websites.&lt;/b&gt;

--


- Before you can extract the data, you need to understand the site design and how the data is contained in it

--

- This means getting familiar with "View Source" and "Developer Tools"

--

- I would recommend getting the "Developer" add-in with Google Chrome, which has an array of tools for inspecting the contents of Web Sites

---



# Viewing Source in Chrome

![](view-source.png)

---



# Practice: Import Data File

1. Navigate to http://www.basketball-reference.com/

2. Use 'View Source' to find where the stats for the 'NBA Standings' are located

3. What is the "id" associated with these data?


---



# Static vs Dynamic Data

Understanding which tools you need to extract data from a Web site starts with determining if the data is _statically_ or _dynamically_ generated on the site.

&lt;br&gt;

.cbox[
## Web data is _static_ if you can see it in the source code. If it isn't there, it's _dynamic_.
]

---

# Practice: Static or Dynamic Data?

1. Have a look at the Tennis Elo Ratings info at the following site:
http://tennisabstract.com/reports/atp_elo_ratings.html

2. Use View Source to determine if the Elo Ratings data are _static_ or _dynamic_.

---

# Solution: It's Static

![](tennis_elo_ratings.png)


---

# Practice: Static or Dynamic Data?

1. Now have a look at another _Tennis Astract_ page with stats on Roger Federer:
http://www.tennisabstract.com/cgi-bin/player.cgi?p=RogerFederer

2. Use View Source to determine if the Elo Ratings data are _static_ or _dynamic_.



---

# Solution: It's Dynamic

![](tennis_abstract_federer.png)

---



# Scraping Static Data

There are a few options for extracting static HTML data.

1. `readLines` is an option if the data is _not_ nicely formatted, in other words, when there is a lack of structure

2. More typically, the data is _nice_ (e.g. if it is contained in a HTML table or other predictable tag) and we can use scraping packages like `rvest` or `RCurl` to get the data in a format we can work with.

---



# Using `rvest`

--

- Suite of tools for scraping static Web data and putting them in easy-to-use objects (like data.frames)

--

- Works with `magrittr` and allows piping commands with `%&gt;%` operator

--

- Allows some browsing functionality

--

- Authored by Hadley Wickham

---



# Example: Scraping Box Scores

In this example, we will use `rvest` to extract the Eastern Division Standings.

First, we import the page content.


```r
library('rvest')

# Creating object with the address
url &lt;- 'http://www.basketball-reference.com/boxscores/'

#Reading the code from the site
webpage &lt;- read_html(url)
```

---



# Example: Scraping Box Scores

The `html_nodes` function is the work horse function for extracting specific elements of a site. We can specify the element we want using its CSS tag or using an XPATH selector.


```r
# Using the CSS table tag to get all tables
data &lt;- webpage %&gt;%
   html_nodes(css = 'table') %&gt;%
   html_table()

length(data) # List of multiple tables
```

```
## [1] 7
```


---



# Example: Scraping Box Scores

Using an XPATH ([XML Path Language](https://en.wikipedia.org/wiki/XPath)) can help to make our extraction more specific, though the syntax is more opaque. 


```r
# Using an XPATH selector to get the specific table of interest
data &lt;- webpage %&gt;%
   html_nodes(xpath = '//*[@id="divs_standings_E"]') %&gt;%
   html_table(header = T)

head(data[[1]])
```

```
##    Eastern Conference                 W                 L
## 1   Atlantic Division Atlantic Division Atlantic Division
## 2    Toronto Raptors*                59                23
## 3     Boston Celtics*                55                27
## 4 Philadelphia 76ers*                52                30
## 5     New York Knicks                29                53
## 6       Brooklyn Nets                28                54
##                W/L%                GB              PS/G              PA/G
## 1 Atlantic Division Atlantic Division Atlantic Division Atlantic Division
## 2              .720                 —             111.7             103.9
## 3              .671               4.0             104.0             100.4
## 4              .634               7.0             109.8             105.3
## 5              .354              30.0             104.5             108.0
## 6              .341              31.0             106.6             110.3
```


---



# Practice: Static Data Extraction

Let's go back to the Elo ratings of male tennis players: [Tennis Abstract Elo](http://tennisabstract.com/reports/atp_elo_ratings.html)

--

1. Use your View Source tools to determine the element containing the ratings

2. Use `rvest` to scrape the data as efficiently as you can

---




# Solution: Elo Rating Extraction

![](tennis-elo.png)

---




# Solution: Elo Rating Extraction


```r
url &lt;- "http://tennisabstract.com/reports/atp_elo_ratings.html"

page &lt;- read_html(url)

# Use table class to extract Elo table
elo &lt;- page %&gt;%
    html_nodes("table.tablesorter") %&gt;%
    html_table()

head(elo)
```

```
## [[1]]
##     Rank                      Player  Age    Elo      Hard   Clay  Grass
## 1      1                Rafael Nadal 32.2 2239.8 NA 2047.8 2252.0 1720.2
## 2      2              Novak Djokovic 31.3 2168.5 NA 2105.6 2056.6 1983.6
## 3      3               Roger Federer 37.1 2136.8 NA 2057.5 1748.4 1897.8
## 4      4       Juan Martin Del Potro 29.9 2102.3 NA 2022.1 1869.0 1691.9
## 5      5            Alexander Zverev 21.4 2034.4 NA 1906.9 2085.2 1701.9
## 6      6                 Andy Murray 31.3 2018.0 NA 1977.9 1954.8 1799.4
## 7      7               Dominic Thiem 25.0 2001.3 NA 1832.9 2062.4 1640.9
## 8      8                David Goffin 27.7 1992.1 NA 1927.7 1923.7 1611.7
## 9      9                 Marin Cilic 29.9 1988.1 NA 1868.9 1820.9 1841.7
## 10    10               Kei Nishikori 28.7 1985.6 NA 1855.3 1977.9 1742.7
## 11    11                Milos Raonic 27.7 1968.8 NA 1881.3 1830.0 1804.1
## 12    12              Kevin Anderson 32.3 1968.5 NA 1858.6 1820.7 1762.0
## 13    13                Nick Kyrgios 23.3 1954.6 NA 1866.3 1635.3 1736.8
## 14    14          Stefanos Tsitsipas 20.0 1954.3 NA 1828.4 1750.9 1612.1
## 15    15                 Borna Coric 21.8 1943.9 NA 1845.5 1796.8 1591.1
## 16    16             Grigor Dimitrov 27.3 1942.5 NA 1913.7 1784.6 1681.5
## 17    17             Karen Khachanov 22.3 1942.0 NA 1808.3 1807.4 1755.1
## 18    18                  John Isner 33.3 1927.8 NA 1847.1 1792.6 1779.6
## 19    19               Fabio Fognini 31.3 1915.5 NA 1833.6 1854.7 1633.9
## 20    20       Roberto Bautista Agut 30.4 1892.4 NA 1810.5 1829.6 1793.2
## 21    21             Daniil Medvedev 22.5 1882.8 NA 1853.5 1429.6 1645.2
## 22    22             Richard Gasquet 32.2 1875.0 NA 1759.9 1841.6 1681.3
## 23    23            Denis Shapovalov 19.4 1874.4 NA 1831.9 1747.9 1485.2
## 24    24               Martin Klizan 29.1 1866.4 NA 1630.0 1870.0 1393.9
## 25    25          Stanislas Wawrinka 33.4 1861.7 NA 1835.0 1850.5 1550.2
## 26    26 Diego Sebastian Schwartzman 26.1 1859.5 NA 1767.9 1840.7 1309.8
## 27    27                Gael Monfils 32.0 1856.4 NA 1841.6 1708.6 1604.1
## 28    28          Jo Wilfried Tsonga 32.8 1854.6 NA 1785.3 1761.8 1607.3
## 29    29         Pablo Carreno Busta 27.2 1836.9 NA 1766.9 1759.6 1349.6
## 30    30         Alexandr Dolgopolov 29.5 1836.6 NA 1760.6 1777.2 1635.1
## 31    31                 Kyle Edmund 23.6 1835.0 NA 1725.0 1811.3 1504.7
## 32    32       Philipp Kohlschreiber 34.9 1829.9 NA 1751.3 1781.9 1607.8
## 33    33               Steve Johnson 28.7 1827.6 NA 1704.2 1782.7 1695.1
## 34    34                John Millman 29.2 1823.5 NA 1763.2 1625.3 1553.0
## 35    35                 Sam Querrey 30.9 1820.8 NA 1721.5 1666.0 1766.9
## 36    36              Radek Stepanek 38.1 1813.7 NA 1735.1 1661.2 1648.8
## 37    37           Fernando Verdasco 34.8 1812.9 NA 1745.1 1794.4 1563.6
## 38    38              Leonardo Mayer 31.3 1811.4 NA 1721.1 1781.0 1515.5
## 39    39               Lucas Pouille 24.5 1811.3 NA 1786.1 1735.0 1632.8
## 40    40           Matteo Berrettini 22.4 1809.1 NA 1561.0 1808.0 1459.9
## 41    41             Feliciano Lopez 36.9 1805.7 NA 1676.0 1740.1 1776.8
## 42    42                Benoit Paire 29.3 1803.1 NA 1718.4 1688.4 1637.0
## 43    43               Nicolas Jarry 22.9 1802.1 NA 1611.5 1776.5 1446.9
## 44    44               Dusan Lajovic 28.2 1797.8 NA 1656.0 1770.0 1464.5
## 45    45               Tomas Berdych 32.8 1795.9 NA 1762.2 1751.1 1645.7
## 46    46                 Hyeon Chung 22.3 1792.6 NA 1725.0 1670.2 1439.7
## 47    47              Francis Tiafoe 20.6 1791.7 NA 1752.5 1518.8 1629.1
## 48    48        Nikoloz Basilashvili 26.5 1791.2 NA 1665.6 1740.6 1486.8
## 49    49                Gilles Simon 33.7 1785.3 NA 1739.3 1716.0 1630.5
## 50    50                 Guido Pella 28.3 1785.2 NA 1603.3 1772.1 1558.6
## 51    51              Alex De Minaur 19.6 1783.7 NA 1778.3 1458.6 1503.9
## 52    52               Jeremy Chardy 31.5 1780.8 NA 1689.4 1722.1 1634.4
## 53    53                Steve Darcis 33.7 1779.5 NA 1695.3 1677.4 1594.4
## 54    54             Nicolas Almagro 32.9 1779.0 NA 1645.6 1801.4 1505.2
## 55    55                David Ferrer 36.4 1776.7 NA 1763.6 1808.2 1533.6
## 56    56            Julien Benneteau 36.7 1773.3 NA 1696.5 1553.4 1579.6
## 57    57                 Robin Haase 31.4 1769.9 NA 1720.6 1629.6 1567.4
## 58    58            Adrian Mannarino 30.2 1769.8 NA 1672.5 1521.9 1672.8
## 59    59                 Taro Daniel 25.6 1765.0 NA 1659.6 1698.9 1320.8
## 60    60              Simone Bolelli 32.8 1761.6 NA 1563.0 1783.1 1597.1
## 61    61                Pablo Cuevas 32.7 1761.6 NA 1653.8 1759.8 1513.3
## 62    62             Peter Gojowczyk 29.1 1761.0 NA 1679.2 1646.6 1544.5
## 63    63               Mischa Zverev 31.0 1760.2 NA 1649.8 1608.0 1622.1
## 64    64            Marcos Baghdatis 33.2 1757.2 NA 1747.3 1503.0 1595.2
## 65    65          Taylor Harry Fritz 20.8 1756.0 NA 1707.1 1618.0 1385.6
## 66    66          Yoshihito Nishioka 23.0 1754.2 NA 1737.7 1450.9 1387.1
## 67    67              Jerzy Janowicz 26.9 1750.6 NA 1669.9 1599.0 1645.4
## 68    68                 Jiri Vesely 25.2 1748.7 NA 1578.5 1673.2 1647.8
## 69    69          Jan Lennard Struff 28.3 1747.8 NA 1657.9 1601.3 1451.8
## 70    70               Ryan Harrison 26.3 1746.6 NA 1727.1 1503.6 1377.5
## 71    71                Aljaz Bedene 29.1 1746.0 NA 1583.7 1738.8 1557.1
## 72    72            Filip Krajinovic 26.5 1742.2 NA 1726.2 1486.9 1410.9
## 73    73               Damir Dzumhur 26.3 1741.7 NA 1707.9 1505.9 1644.2
## 74    74            Marco Cecchinato 25.9 1737.5 NA 1306.1 1820.8 1485.9
## 75    75                Daniel Evans 28.3 1737.4 NA 1740.3 1527.3 1472.0
## 76    76               Tommy Robredo 36.3 1734.2 NA 1677.5 1659.2 1480.6
## 77    77               Andreas Seppi 34.5 1733.8 NA 1700.4 1659.6 1611.5
## 78    78       Pierre Hugues Herbert 27.4 1732.9 NA 1648.2 1630.7 1538.6
## 79    79             Henri Laaksonen 26.4 1732.3 NA 1645.0 1666.0 1422.2
## 80    80           Mikhail Kukushkin 30.7 1730.7 NA 1653.7 1558.5 1538.3
## 81    81              Ernests Gulbis 29.8 1727.4 NA 1594.7 1712.2 1607.2
## 82    82                   Jack Sock 25.9 1722.5 NA 1724.7 1684.6 1519.9
## 83    83            Marton Fucsovics 26.5 1721.8 NA 1602.2 1713.8 1403.0
## 84    84                 Denis Kudla 26.0 1720.0 NA 1585.2 1477.7 1538.1
## 85    85            Andrey Kuznetsov 26.6 1719.5 NA 1582.9 1713.2 1474.8
## 86    86              Viktor Troicki 32.5 1717.7 NA 1663.1 1674.6 1538.3
## 87    87                 Lukas Rosol 33.1 1717.4 NA 1620.9 1682.0 1439.8
## 88    88                 Jaume Munar 21.3 1717.3 NA 1563.5 1667.4 1500.0
## 89    89               Denis Istomin 32.0 1715.5 NA 1643.6 1629.3 1617.4
## 90    90               Jurgen Melzer 36.9 1712.3 NA 1653.9 1642.7 1623.4
## 91    91            Janko Tipsarevic 33.2 1712.3 NA 1705.3 1646.8 1607.9
## 92    92               Andrey Rublev 20.9 1709.9 NA 1634.1 1625.9 1544.3
## 93    93                 Laslo Djere 23.3 1709.5 NA 1382.1 1759.5 1401.2
## 94    94                  Joao Sousa 29.4 1707.5 NA 1670.4 1655.9 1470.6
## 95    95               Pablo Andujar 32.3 1707.4 NA 1459.9 1751.5 1306.9
## 96    96                 Yen Hsun Lu 34.1 1706.6 NA 1636.5 1439.3 1585.8
## 97    97               Bernard Tomic 25.8 1706.5 NA 1661.7 1499.0 1640.8
## 98    98              Cameron Norrie 23.0 1703.9 NA 1588.3 1653.7 1426.4
## 99    99                   Dudi Sela 33.3 1701.8 NA 1647.7 1328.3 1619.8
## 100  100                Albert Ramos 30.6 1700.1 NA 1580.8 1715.4 1483.4
## 101  101                  Tommy Haas 39.3 1698.6 NA 1602.7 1636.5 1513.1
## 102  102                Ivo Karlovic 39.4 1697.6 NA 1643.8 1604.9 1655.5
## 103  103             Jared Donaldson 21.8 1695.6 NA 1648.5 1516.2 1404.8
## 104  104            Horacio Zeballos 33.4 1694.0 NA 1594.7 1662.8 1275.2
## 105  105               Matthew Ebden 30.8 1694.0 NA 1555.6 1333.4 1596.9
## 106  106             Albert Montanes 36.4 1691.8 NA 1480.6 1698.8 1419.9
## 107  107           Federico Delbonis 27.9 1691.5 NA 1630.7 1691.2 1297.6
## 108  108               Andrej Martin 28.8 1687.9 NA 1460.2 1668.7 1473.9
## 109  109               Nicolas Mahut 36.6 1681.5 NA 1625.3 1549.7 1654.7
## 110  110      Guillermo Garcia Lopez 35.2 1680.6 NA 1571.8 1682.5 1468.8
## 111  111           Ricardo Rodriguez 24.9 1679.8 NA 1718.0 1542.9 1500.0
## 112  112                Malek Jaziri 34.6 1674.8 NA 1604.7 1686.8 1359.0
## 113  113          Thanasi Kokkinakis 22.3 1674.1 NA 1598.9 1492.7 1483.4
## 114  114               Gilles Muller 35.3 1673.6 NA 1583.5 1524.4 1626.2
## 115  115           Marcel Granollers 32.4 1672.7 NA 1576.7 1615.1 1557.2
## 116  116     Roberto Carballes Baena 25.4 1671.2 NA 1568.6 1646.6 1362.1
## 117  117                  Ivan Dodig 32.5 1671.0 NA 1523.2 1732.8 1578.4
## 118  118                Donald Young 29.1 1670.5 NA 1625.6 1434.3 1489.2
## 119  119               Jozef Kovalik 25.7 1670.4 NA 1648.6 1542.3 1471.3
## 120  120                Marius Copil 27.9 1669.8 NA 1712.7 1470.9 1457.8
## 121  121                Dustin Brown 33.3 1664.3 NA 1581.0 1556.9 1581.1
## 122  122           Sergiy Stakhovsky 32.5 1663.4 NA 1597.1 1508.8 1561.3
## 123  123              Evgeny Donskoy 28.3 1653.6 NA 1599.4 1457.0 1360.9
## 124  124             Thiago Monteiro 24.1 1652.6 NA 1458.1 1634.5 1518.1
## 125  125                 Darian King 25.9 1652.5 NA 1621.9 1405.3 1500.0
## 126  126                 Casper Ruud 19.7 1652.5 NA 1426.7 1657.4 1500.0
## 127  127             Thomaz Bellucci 30.4 1652.3 NA 1602.5 1629.7 1401.0
## 128  128                Tobias Kamke 31.2 1651.0 NA 1560.5 1629.9 1521.7
## 129  129         Ramkumar Ramanathan 23.8 1648.6 NA 1502.6 1476.3 1628.1
## 130  130              Vasek Pospisil 28.2 1646.4 NA 1620.0 1263.2 1502.0
## 131  131             Tennys Sandgren 27.1 1638.2 NA 1631.3 1473.8 1438.6
## 132  132             Ruben Bemelmans 30.6 1635.9 NA 1540.8 1421.1 1482.6
## 133  133               Florian Mayer 34.9 1631.8 NA 1563.3 1593.7 1635.9
## 134  134             Thomas Fabbiano 29.2 1631.0 NA 1477.2 1421.9 1542.3
## 135  135         Maximilian Marterer 23.2 1628.3 NA 1557.3 1626.6 1375.5
## 136  136            Thiemo De Bakker 30.0 1627.9 NA 1534.8 1669.8 1463.6
## 137  137          Paul Henri Mathieu 35.7 1626.0 NA 1529.3 1659.1 1553.2
## 138  138                  Rajeev Ram 33.3 1625.3 NA 1546.5 1563.0 1544.6
## 139  139              Carlos Berlocq 35.6 1624.8 NA 1567.6 1599.6 1333.8
## 140  140                 Lukas Lacko 30.8 1623.5 NA 1516.5 1390.5 1523.1
## 141  141                Yuki Bhambri 26.1 1621.0 NA 1619.6 1452.9 1416.1
## 142  142             Mikhail Youzhny 36.1 1618.1 NA 1612.8 1512.0 1555.4
## 143  143            Santiago Giraldo 30.8 1616.1 NA 1521.3 1610.2 1476.5
## 144  144             Alejandro Falla 33.2 1609.0 NA 1559.8 1563.2 1514.2
## 145  145                Samuel Groth 29.7 1607.6 NA 1451.5 1505.2 1560.5
## 146  146               Reilly Opelka 20.5 1607.4 NA 1593.3 1441.2 1423.7
## 147  147                Ilya Ivashka 24.4 1604.8 NA 1649.1 1452.2 1500.0
## 148  148              Nicolas Kicker 25.8 1602.5 NA 1549.3 1553.6 1463.6
## 149  149                  Radu Albot 28.8 1602.3 NA 1458.4 1507.4 1587.2
## 150  150           Ricardas Berankis 28.2 1601.7 NA 1592.3 1388.5 1267.2
## 151  151                 Mirza Basic 27.2 1597.4 NA 1643.9 1458.9 1375.7
## 152  152               Paolo Lorenzi 36.7 1588.9 NA 1551.7 1545.3 1291.5
## 153  153             Stephane Robert 38.1 1585.8 NA 1492.4 1575.5 1443.5
## 154  154                    Go Soeda 33.1 1582.3 NA 1516.8 1465.7 1369.1
## 155  155             Illya Marchenko 29.9 1582.0 NA 1560.6 1411.4 1332.0
## 156  156         Rogerio Dutra Silva 34.4 1581.5 NA 1468.3 1559.0 1299.8
## 157  157            Bjorn Fratangelo 25.0 1579.7 NA 1484.4 1579.9 1505.4
## 158  158                 Tim Smyczek 30.7 1579.6 NA 1496.6 1430.8 1505.5
## 159  159                 Renzo Olivo 26.0 1578.8 NA 1404.2 1566.7 1442.2
## 160  160                    Ze Zhang 27.7 1578.6 NA 1472.2 1569.0 1503.8
## 161  161               Gerald Melzer 28.0 1576.2 NA 1362.5 1608.4 1500.0
## 162  162                 Blaz Kavcic 31.3 1572.6 NA 1488.7 1516.0 1357.1
## 163  163                Gastao Elias 27.7 1570.0 NA 1363.8 1652.9 1344.4
## 164  164               Yuichi Sugita 29.9 1569.5 NA 1524.0 1426.8 1538.1
## 165  165            Ernesto Escobedo 22.1 1566.4 NA 1553.2 1471.3 1429.8
## 166  166           Kenny De Schepper 30.7 1565.3 NA 1536.9 1403.7 1479.0
## 167  167              Peter Polansky 30.2 1561.0 NA 1555.0 1405.8 1394.3
## 168  168               Quentin Halys 21.8 1558.8 NA 1503.3 1431.9 1500.0
## 169  169                Marsel Ilhan 30.9 1556.0 NA 1571.4 1413.2 1400.9
## 170  170             James Duckworth 26.6 1550.2 NA 1517.3 1443.4 1388.9
## 171  171              Facundo Bagnis 28.5 1542.9 NA 1420.1 1552.0 1374.9
## 172  172                  Elias Ymer 22.3 1535.4 NA 1456.2 1484.5 1472.0
## 173  173                       Di Wu 26.5 1528.0 NA 1490.9 1408.6 1397.2
## 174  174             Victor Estrella 38.0 1525.6 NA 1444.4 1632.7 1361.7
## 175  175             Jordan Thompson 24.4 1514.2 NA 1485.4 1459.7 1414.0
## 176  176          Alejandro Gonzalez 29.1 1502.9 NA 1492.5 1416.3 1383.2
## 177  177                  Joao Souza 28.8 1475.8 NA 1398.4 1451.1 1435.1
## 178  178         Konstantin Kravchuk 32.6 1420.9 NA 1278.3 1590.5 1381.0
## 179  179              Norbert Gombos 27.9 1415.5 NA 1395.1 1397.1 1414.8
##                           Peak Match Peak Age Peak Elo
## 1   NA         2009 Madrid Masters F     22.9   2388.4
## 2   NA  2016 Monte Carlo Masters R32     28.9   2459.9
## 3   NA 2007 Indian Wells Masters R64     25.6   2405.7
## 4   NA                2009 Tokyo R32     21.0   2256.6
## 5   NA   2017 Cincinnati Masters R32     20.3   2136.8
## 6   NA                   2017 Doha F     29.6   2334.7
## 7   NA                 2016 Halle SF     22.8   2116.5
## 8   NA           2017 Monte Carlo SF     26.4   2034.6
## 9   NA                 2010 Dubai QF     21.4   2110.6
## 10  NA               2016 Us Open SF     26.7   2201.9
## 11  NA              2016 Wimbledon F     25.5   2144.4
## 12  NA      2015 Shanghai Masters QF     29.4   2004.6
## 13  NA     2017 Cincinnati Masters F     22.3   2081.9
## 14  NA         2018 Canada Masters F     20.0   2012.4
## 15  NA           2018 Wimbledon R128     21.6   1966.8
## 16  NA        2014 Canada Masters SF     23.2   2099.1
## 17  NA   2018 Cincinnati Masters R16     22.2   1950.8
## 18  NA              2012 US Open R32     27.3   2045.5
## 19  NA  2014 Monte Carlo Masters R16     26.9   2014.3
## 20  NA             2016 Rotterdam QF     27.8   2020.2
## 21  NA            2017 Washington QF     21.5   1920.4
## 22  NA              2007 Adelaide QF     20.5   2046.8
## 23  NA        2018 Roland Garros R64     19.1   1919.4
## 24  NA             2015 Barcelona SF     25.8   1895.6
## 25  NA      2016 Australian Open R16     30.8   2136.5
## 26  NA             2018 Acapulco R16     25.5   1942.4
## 27  NA          2010 Paris Masters F     24.2   2061.4
## 28  NA 2009 Indian Wells Masters R32     23.9   2170.8
## 29  NA                2016 Basel R16     25.3   1933.7
## 30  NA        2011 Costa Do Sauipe F     22.3   1963.2
## 31  NA       2018 Australian Open SF     23.0   1935.4
## 32  NA            2009 Stuttgart R16     25.7   2002.3
## 33  NA    2016 Cincinnati Masters QF     26.6   1926.9
## 34  NA         2016 Winston-Salem SF     27.2   1872.4
## 35  NA         2012 Paris Masters QF     25.1   1959.1
## 36  NA         2009 Paris Masters SF     31.0   2021.8
## 37  NA          2010 Rome Masters SF     26.4   2109.1
## 38  NA        2014 Winston-Salem R32     27.3   1882.1
## 39  NA              2016 Beijing R16     22.6   1996.1
## 40  NA        2018 Winston Salem R16     22.4   1886.5
## 41  NA             2005 Marseille SF     23.4   1959.0
## 42  NA                  2015 Tokyo F     26.4   1904.7
## 43  NA              2018 Sao Paulo F     22.4   1831.2
## 44  NA              2018 Antalya R16     28.0   1803.7
## 45  NA  2013 Indian Wells Masters SF     27.5   2129.7
## 46  NA         2018 Miami Masters QF     21.8   1958.4
## 47  NA                2018 Estoril F     20.3   1884.8
## 48  NA        2017 Roland Garros R32     25.3   1842.9
## 49  NA            2009 Rotterdam R16     24.1   2031.2
## 50  NA                   2018 Umag F     28.2   1814.2
## 51  NA              2018 Us Open R32     19.5   1855.3
## 52  NA                2009 Gstaad QF     22.5   1929.8
## 53  NA         2012 Winston-Salem QF     28.4   1890.5
## 54  NA                2012 Tokyo R32     27.1   2040.2
## 55  NA               2013 Acapulco F     30.9   2214.9
## 56  NA              2013 Rotterdam F     31.1   1903.2
## 57  NA                2008 Zagreb QF     20.9   1865.9
## 58  NA      2018 Australian Open R32     29.5   1876.3
## 59  NA         2018 Winston Salem SF     25.6   1797.5
## 60  NA        2008 Roland Garros R32     22.6   1933.3
## 61  NA                2016 Hamburg F     30.5   1900.0
## 62  NA           2018 Delray Beach F     28.6   1892.3
## 63  NA       2017 Australian Open QF     29.4   1839.3
## 64  NA  2006 Indian Wells Masters QF     20.7   2026.2
## 65  NA                  2018 Lyon QF     20.6   1849.9
## 66  NA      2018 Australian Open R64     22.3   1841.8
## 67  NA       2013 Canada Masters R16     22.7   1959.1
## 68  NA        2017 Roland Garros R32     23.9   1841.3
## 69  NA                2017 Vienna QF     27.5   1798.0
## 70  NA 2012 Indian Wells Masters R16     19.8   1827.5
## 71  NA              2018 Budapest SF     28.8   1841.0
## 72  NA        2018 Miami Masters R16     26.1   1817.7
## 73  NA              2017 Shenzhen SF     25.3   1926.7
## 74  NA              2018 Hamburg R32     25.8   1861.9
## 75  NA      2017 Australian Open R16     26.7   1880.6
## 76  NA         2009 Roland Garros QF     27.1   1995.7
## 77  NA             2005 Stuttgart QF     21.4   1903.4
## 78  NA          2015 Winston-Salem F     24.4   1804.9
## 79  NA              2017 Antwerp R16     25.5   1754.3
## 80  NA                 2011 Doha R32     23.0   1917.8
## 81  NA         2014 Roland Garros SF     25.7   2048.3
## 82  NA  2017 Indian Wells Masters SF     24.4   2032.3
## 83  NA        2018 Roland Garros R64     26.3   1835.6
## 84  NA               2015 Atlanta SF     22.9   1736.7
## 85  NA                2016 Geneva QF     25.2   1880.3
## 86  NA   2011 Monte Carlo Masters QF     25.2   2001.7
## 87  NA         2013 Rome Masters R64     27.8   1877.4
## 88  NA              2018 Us Open R64     21.3   1740.6
## 89  NA            2014 Wimbledon R32     27.8   1851.7
## 90  NA         2010 Paris Masters QF     29.5   1967.4
## 91  NA               2012 Bangkok SF     28.3   2055.8
## 92  NA             2018 Rotterdam QF     20.3   1925.8
## 93  NA            2018 Kitzbuhel R16     23.2   1760.2
## 94  NA      2016 Australian Open R32     26.8   1859.9
## 95  NA            2012 Barcelona R32     26.2   1804.9
## 96  NA 2014 Indian Wells Masters R32     30.6   1804.2
## 97  NA      2012 Australian Open R16     19.2   1941.7
## 98  NA        2018 Cabo San Lucas SF     22.9   1783.9
## 99  NA               2009 Memphis SF     23.9   1860.1
## 100 NA             2017 Barcelona QF     29.3   1879.3
## 101 NA       2002 Australian Open SF     23.8   2122.4
## 102 NA        2007 Paris Masters R32     28.7   2002.1
## 103 NA               2017 Chengdu QF     21.0   1833.5
## 104 NA               2010 Houston SF     24.9   1794.2
## 105 NA 2012 Indian Wells Masters R16     24.3   1853.5
## 106 NA              2001 Bucharest F     20.8   1901.5
## 107 NA                2013 Hamburg F     22.8   1852.8
## 108 NA                 2018 Quito SF     28.4   1773.2
## 109 NA                  2007 Metz SF     25.7   1888.7
## 110 NA      2010 Shanghai Masters QF     27.4   1882.2
## 111 NA          2014 Davis Cup G1 R1     20.8   1708.3
## 112 NA        2017 Miami Masters R32     33.2   1804.3
## 113 NA              2017 Los Cabos F     21.3   1762.6
## 114 NA             2017 Wimbledon QF     34.2   1986.9
## 115 NA               2012 Sydney R32     25.7   1917.6
## 116 NA         2018 Buenos Aires R32     24.9   1749.3
## 117 NA             2011 Barcelona SF     26.3   1954.0
## 118 NA        2017 Miami Masters R16     27.7   1852.3
## 119 NA               2018 Hamburg SF     25.7   1729.6
## 120 NA       2015 s-Hertogenbosch QF     24.6   1758.3
## 121 NA         2017 Delray Beach R32     32.2   1825.4
## 122 NA         2010 Kuala Lumpur R16     24.7   1910.3
## 123 NA                2015 Moscow SF     25.4   1704.3
## 124 NA                2016 Gstaad QF     22.1   1776.1
## 125 NA          2018 Davis Cup G1 R1     25.8   1792.1
## 126 NA                2018 Bastad QF     19.6   1706.7
## 127 NA               2010 Hamburg QF     22.6   1934.6
## 128 NA               2014 Hamburg QF     28.1   1731.7
## 129 NA                2018 Newport F     23.7   1721.6
## 130 NA              2015 Valencia SF     25.3   1851.1
## 131 NA                2018 Houston F     26.7   1725.2
## 132 NA               2017 Antwerp SF     29.8   1745.6
## 133 NA        2011 Roland Garros R64     27.6   1941.0
## 134 NA       2018 Cabo San Lucas R16     29.2   1647.1
## 135 NA            2018 Stuttgart R16     23.0   1777.2
## 136 NA             2010 New Haven SF     21.9   1887.3
## 137 NA           2002 Davis Cup WG F     20.9   2038.9
## 138 NA            2009 New Haven R16     25.4   1794.3
## 139 NA                  2014 Nice QF     31.3   1848.4
## 140 NA                 2012 Zagreb F     24.2   1804.9
## 141 NA        2018 Miami Masters R64     25.7   1742.2
## 142 NA                  2007 Dubai F     24.7   2031.8
## 143 NA               2012 Munich R16     24.4   1868.9
## 144 NA            2006 Wimbledon R64     22.6   1804.0
## 145 NA        2015 Winston-Salem R32     27.8   1805.2
## 146 NA              2017 Memphis R16     19.5   1707.5
## 147 NA                 2018 Pune R16     23.9   1696.0
## 148 NA               2017 Hamburg QF     24.9   1763.4
## 149 NA          2015 Davis Cup G2 R1     25.3   1699.9
## 150 NA          2013 Delray Beach QF     22.7   1850.9
## 151 NA       2018 Miami Masters R128     26.7   1863.7
## 152 NA              2017 Budapest SF     35.4   1758.3
## 153 NA           2010 Casablanca R16     29.9   1789.2
## 154 NA          2012 Davis Cup WG R1     27.4   1747.5
## 155 NA        2010 Miami Masters R64     22.5   1835.1
## 156 NA             2013 Santiago R32     29.0   1678.5
## 157 NA              2017 Us Open R64     24.1   1692.2
## 158 NA              2013 US Open R32     25.7   1722.2
## 159 NA                 2016 Quito QF     23.9   1732.4
## 160 NA             2016 Shenzhen R32     26.2   1615.5
## 161 NA                 2018 Quito QF     27.6   1647.7
## 162 NA        2011 Roland Garros R64     24.2   1727.8
## 163 NA             2016 Olympics R32     25.7   1711.6
## 164 NA    2017 Cincinnati Masters QF     28.9   1826.7
## 165 NA               2017 Houston SF     20.8   1750.4
## 166 NA            2013 Wimbledon R16     26.1   1616.8
## 167 NA          2011 Davis Cup WG PO     23.2   1665.5
## 168 NA        2016 Roland Garros R64     19.6   1586.5
## 169 NA            2010 Rotterdam R16     22.7   1716.7
## 170 NA                  2015 Nice QF     23.3   1685.8
## 171 NA             2016 Marrakech QF     26.1   1628.2
## 172 NA            2015 Barcelona R16     19.0   1610.5
## 173 NA             2015 Shenzhen R32     24.0   1710.2
## 174 NA                2015 Munich QF     34.7   1848.4
## 175 NA              2017 Us Open R64     23.4   1744.8
## 176 NA               2014 Houston QF     25.2   1667.6
## 177 NA              2010 Santiago SF     21.7   1709.4
## 178 NA       2010 St. Petersburg R16     25.7   1609.9
## 179 NA          2014 Davis Cup G1 R2     23.6   1597.1
```

---

# Handling Dynamic Data 

- Because dynamic data is created on-the-fly we can't simply read from the HTML to get those data

--

- There are &lt;b&gt;two&lt;/b&gt; main ways we can deal with this:

  1. Sleuth the underlying data objects
  
  2. Use automated browsing to make the dynamic problem a static problem

---

# Sleuthing

.pull-left[
- Dynamic data has to come from somewhere. 

- Usually data is stored in a server and made available to JS functions via JSON/XML files.

- If we can find and access those data files, our scraping dilemma is essentially solved.
]

.pull-right[
![](inspector_gadget.gif)
]

---

# Sleuth Principles

1. If data is dynamic, fire up "Developer Tools"

2. Select XHR for (XML HTTP Request) [This is where events happen]

3. Make an event by selecting the data of interest

4. Review requests and look for JSON/XML content in the "Response" field

---

# Example: World Cup Data

![](football_world_cup.png)


---


# Example: World Cup Data

![](football_xhr.png)

---

# Importing the Data

With a URL location for the data file, JSON in this case, we can easily read in these data to R.


```r
library(jsonlite) # Reading JSON files

url &lt;-
 "https://www.sofascore.com/tournament/3958/15586/standings/tables/json?"

data &lt;- fromJSON(url)

data$teamEvents[[1]]$total
```

```
##        id customId homeTeam.id homeTeam.name awayTeam.id awayTeam.name
## 1 7659866  gVbsfCc        4756    Costa Rica        6355        Serbia
## 2 7659881  ZTbsfCc        6355        Serbia        4699   Switzerland
## 3 7659890  YUbsfCc        6355        Serbia        4748        Brazil
##   current current winnerCode               slug startTimestamp
## 1       0       1          2  serbia-costa-rica     1529236800
## 2       1       2          2 serbia-switzerland     1529690400
## 3       0       2          2      serbia-brazil     1530122400
```

---

# XHR Patterns

Using the XHR info to get at the data objects behind dynamic pages, the scraping problem largely reduces to:

1. Identifying patterns in the XHR

2. Parsing the resulting objects

---

# XHR Patterns


What do I mean by XHR pattern? Consider our Brazil example...

What if we want another WC group?


```r
url &lt;-
 "https://www.sofascore.com/tournament/GROUP/15586/standings/tables/json?"

data &lt;- fromJSON(sub("GROUP", 3959, url))

data$teamEvents[[1]]$total
```

```
##        id customId homeTeam.id homeTeam.name awayTeam.id awayTeam.name
## 1 7659868  lUbsGVb        4711       Germany        4781        Mexico
## 2 7659888  KUbsGVb        4735   South Korea        4781        Mexico
## 3 7659905  NTbsGVb        4781        Mexico        4688        Sweden
##   current current winnerCode               slug startTimestamp
## 1       0       1          2     mexico-germany     1529247600
## 2       1       2          2 mexico-south-korea     1529766000
## 3       0       3          2      mexico-sweden     1530108000
```


---


# Automated Browsing

- Sadly, many dynamic sites will hide their backend data

--

- But we can still deal with this!

--

- We just need to find what instructions to give to mimic the browsing that generates the data and get familiar with tools that can implement these instructions


---



# RSelenium

--

- _Selenium_ is software that allows automated Web browsing

--

- [RSelenium](https://cran.r-project.org/web/packages/RSelenium/index.html) is a package that provides Selenium functionality in R

![](selenium_rc.png)

---



# RSelenium Installation

- Although you can install and run RSelenium locally, you can save yourself a lot of pain by using RSelenium through _docker_.

- Once _docker_ is installed there are many images available that are already setup with Selenium : https://hub.docker.com/u/selenium/

![](docker.png)

---



# RSelenium: Basic Steps

1. Set the Web driver (select browser and port)

2. Find the elements with the data

3. Extract the content

4. Parse the contents

---



# Setting Up Docker

1. We will use the `selenium/standalone-chrome` docker image in our examples

2. Once docker is running, we can initiate this image on port 4445 with the code shown at the bottom. 

3. We can now use RSelenium on port 4445



```r
docker run -d -p 4445:4444 selenium/standalone-chrome
```

---

# Using RSelenium

Take a look at the NFL Standings at: https://www.nfl.com/standings


&lt;div style="margin-left: 15%;"&gt;
&lt;img src="nfl_standings.png" width="80%" /&gt;
&lt;/div&gt;


---


# Using RSelenium

Below we activate the driver on the designated docker port (using `L` to ensure it is treated as an integer)


```r
library(RSelenium) # Load the package

url &lt;- "https://www.nfl.com/standings"

remDr &lt;- remoteDriver(port = 4445L, browser = "chrome")
    # Establish driver
remDr$open(silent = TRUE) # Supress any output messages
remDr$navigate(url) # Navigate page
```

---

# Using RSelenium

Inspection of the source code suggests that the Element with `class` *rsv-ae9db127* is likely to contain the statistics about game results. To isolate that element we use `findElements`.


```r
webElem &lt;- remDr$findElements(using = "class", 
    "rsv-ae9db127")
```

---

# Using RSelenium

Once we have isolated the elements of interest, we can extract info about its attributes or (most importantly) the text embedded in those elements. 


```r
# Use getElementText to extract
# the text from this element
unlist(lapply(webElem, function(x) {
    x$getElementText()
}))[29:35]
```

```
## [1] "New York\nJets"                                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [2] "Buffalo\nBills"                                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [3] "Buffalo\nBills"                                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [4] "Buffalo\nBills"                                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [5] "AFC North Team\nW L T PCT PF PA Net Pts Home Road Div Pct Conf Pct Non-Conf Streak Last 5\nCincinnati\nBengals\n2 0 0 1.000 68 46 22 1-0-0 1-0-0 1-0-0 1.000 2-0-0 1.000 0-0-0 2W 2-0-0\nBaltimore\nRavens\n1 1 0 .500 70 37 33 1-0-0 0-1-0 0-1-0 .000 1-1-0 .500 0-0-0 1L 1-1-0\nCleveland\nBrowns\n1 1 1 .500 60 59 1 1-0-1 0-1-0 0-0-1 .500 1-0-1 .750 0-1-0 1W 1-1-1\nPittsburgh\nSteelers\n0 1 1 .250 58 63 -5 0-1-0 0-0-1 0-0-1 .500 0-1-1 .250 0-0-0 1L 0-1-1"
## [6] "Cincinnati\nBengals"                                                                                                                                                                                                                                                                                                                                                                                                                                                 
## [7] "Cincinnati\nBengals"
```

```r
remDr$close()  # Close driver when finished
```

---



# Summary

- Web data can be classed into three main categories: directly importable, static, or dynamic

- We can use Web developer tools to determine which data type we are working with and the site elements that contain the data

- We have seen how we use tools like `rvest` to capture static Web data

- For dynamic data, we can use automated browsing with `RSelenium` 

---


# Resources

- [XPATH: https://www.w3schools.com/xml/xpath_intro.asp](https://www.w3schools.com/xml/xpath_intro.asp)

- [rvest: https://www.r-bloggers.com/rvest-easy-web-scraping-with-r/](https://www.r-bloggers.com/rvest-easy-web-scraping-with-r/)

- [RSelenium: https://ropensci.org/tutorials/rselenium_tutorial.html](https://ropensci.org/tutorials/rselenium_tutorial.html)

- [docker: https://ropenscilabs.github.io/r-docker-tutorial/](https://ropenscilabs.github.io/r-docker-tutorial/)
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
